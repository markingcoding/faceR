<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <link rel="shortcut icon" href="assets/images/logo2.png" type="image/x-icon">
  <meta name="description" content="Website Creator Description">
  <title>face</title>
  <link rel="stylesheet" href="assets/web/assets/mobirise-icons/mobirise-icons.css">
  <link rel="stylesheet" href="assets/tether/tether.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="assets/socicon/css/styles.css">
  <link rel="stylesheet" href="assets/dropdown/css/style.css">
  <link rel="stylesheet" href="assets/theme/css/style.css">
  <link rel="stylesheet" href="assets/mobirise/css/mbr-additional.css" type="text/css">



</head>
<body>
  <section class="menu cid-qTkzRZLJNu" once="menu" id="menu1-y">
      <nav class="navbar navbar-expand beta-menu navbar-dropdown align-items-center navbar-fixed-top navbar-toggleable-sm">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
        <div class="menu-logo">
            <div class="navbar-brand">
                <span class="navbar-logo">
                    <a href="index.html">
                         <img src="assets/images/pinclipart.com-cliparts-smilies-kostenlos-1169897-76x76.png" alt="" title="" style="height: 3.8rem;">
                    </a>
                </span>
                <span class="navbar-caption-wrap"><a class="navbar-caption text-white display-4" href="index.html">FaceR<br></a></span>
            </div>
        </div>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav nav-dropdown nav-right" data-app-modern-menu="true">
                <li class="nav-item">
                    <a class="nav-link link text-white display-4" href="#">
                        <span class="mbri-home mbr-iconfont mbr-iconfont-btn"></span>
                        ミッション
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link link text-white display-4" href="#">
                        <span class="mbri-search mbr-iconfont mbr-iconfont-btn"></span>
                        About Us
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</section>

  <section class="cid-rjWzhL9yBH mbr-fullscreen" id="header2-15" style="background-image: url('assets/images/mbr-1920x1079.jpg');background-repeat: no-repeat;background-size: cover;background-position: center;margin-top:60px;">
      <div class="container align-center" style="margin-top: -50px; position: relative;">
          <!--<div class="row justify-content-md-center">-->
              <!--<video id="v" class="col-xs-12 col-sm-12 col-md-10 col-lg-8 col-xl-8"></video>-->
          <!--<img id="imgback" src="">-->
          <video autoplay style="height: 360px;width: 540px; position: absolute;" id="video"
                 width="540"
                 height="360"
                 autoplay
                 loop
                 playsinline></video>
          <canvas id="canvas"
                  width="540"
                  height="360" style="position: absolute;"></canvas>
          <img id='croppedImage' style="opacity:0;" hidden/>
          <img id='resizedImage' style="opacity:0;" hidden/>
          <img id="graph" src="assets/images/distance_fig.png" style="height:360px;width:540px;">
              <!--<div class="mbr-white col-md-10" style="margin-top:-380px">-->
                  <!--<div class="video-block">-->
                      <!--<div><iframe class="mbr-embedded-video" src="https://www.youtube.com/embed/Pls_q2aQzHg?rel=0&amp;amp;showinfo=0&amp;autoplay=0&amp;loop=0" width="750" height="306" frameborder="0"></iframe></div>-->
                  <!--</div>-->
              <!--</div>-->
          <!--</div>-->
      </div>
  </section>


  <section class="mbr-section contacts2 cid-rjz7Nes8YJ" id="contacts2-s">
      <!---->

      <!---->
      <!--Overlay-->

      <!--Container-->
      <div class="container">
          <div class="row">
              <!--Titles-->
              <div class="title col-12">
                  <h2 class="align-left mbr-fonts-style display-1">
                      Our Contacts
                  </h2>

              </div>
              <div class="col-12">
                  <div class="row justify-content-center">
                      <div class="col-12 col-md-4">
                          <div class="b b-adress">
                              <h5 class="align-left mbr-fonts-style m-0 display-5">
                                  Address:
                              </h5>
                              <p class="mbr-text align-left mbr-fonts-style display-7">
                                  〒170-0013 東京都豊島区東池袋2-38-23 SAMビル3階（株式会社ロボケンAI研究開発部・開発拠点）</p>
                          </div>
                      </div>
                      <div class="col-12 col-md-4">
                          <div class="b b-phone">
                              <h5 class="align-left mbr-fonts-style m-0 display-5">
                                  Phone:
                              </h5>
                              <p class="mbr-text align-left mbr-fonts-style display-7">
                                  +81-(0)3-6915-2310</p>
                              <h5 class="align-left mbr-fonts-style m-0 display-5">
                                  Fax:
                              </h5>
                              <p class="mbr-text align-left mbr-fonts-style display-7">
                                  +81-(0)3-6915-2827</p>
                          </div>
                      </div>
                      <div class="col-12 col-md-4">
                          <div class="b b-mail">
                              <h5 class="align-left mbr-fonts-style m-0 display-5">
                                  E-mail:
                              </h5>
                              <p class="mbr-text align-left mbr-fonts-style display-7">
                                  yasuomi.d.sato@roboken2.com
                              </p>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </section>

<section once="" class="cid-rjz7QG9ZjS" id="footer7-z">
    <div class="container">
        <div class="media-container-row align-center mbr-white">
            <div class="row row-links">
                <ul class="foot-menu">





                <li class="foot-menu-item mbr-fonts-style display-7">
                        <a class="text-white mbr-bold" href="#" target="_blank">About us</a>
                    </li></ul>
            </div>
            <div class="row row-copirayt">
                <p class="mbr-text mb-0 mbr-fonts-style mbr-white align-center display-7">
                    © Copyright 2019 faceR - All Rights Reserved
                </p>
            </div>
        </div>
    </div>
</section>


  <script src="assets/web/assets/jquery/jquery.min.js"></script>
  <script src="assets/popper/popper.min.js"></script>
  <script src="assets/tether/tether.min.js"></script>
  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/smoothscroll/smooth-scroll.js"></script>
  <script src="assets/touchswipe/jquery.touch-swipe.min.js"></script>
  <script src="assets/playervimeo/vimeo_player.js"></script>
  <script src="assets/ytplayer/jquery.mb.ytplayer.min.js"></script>
  <script src="assets/vimeoplayer/jquery.mb.vimeo_player.js"></script>
  <script src="assets/dropdown/js/script.min.js"></script>
  <script src="assets/theme/js/script.js"></script>
  <script src="assets/socketio/socketio.js"></script>
  <script src="assets/libs/utils.js"></script>
  <script src="assets/libs/lodash.min.js"></script>
  <script src="assets/clmtrackr/clmtrackr.js"></script>

  <script>
      $(document).ready(function() {
          const videoInput = document.getElementById('video');
          const canvasInput = document.getElementById('canvas');
          const out = document.getElementById('out')

          const ctx = canvasInput.getContext('2d');

          const ctracker = new clm.tracker();
          ctracker.init();
          ctracker.start(videoInput);

          let posX = 0;
          let posY = 0;
          let width = 0;
          let height = 0;

          const croppedImageTag = document.getElementById('croppedImage');
          let croppedImage = '';

          const resizedImageTag = document.getElementById('resizedImage');
          let resizedImage = '';

          function positionLoop() {
              requestAnimFrame(positionLoop);
              const positions = ctracker.getCurrentPosition();
              // do something with the positions ...
              // print the positions
              let positionString = "";
              if (positions) {
                  const posX_original = _.minBy(positions, p => p[0])[0];
                  const posY_original = _.minBy(positions, p => p[1])[1];
                  const maxLeft = _.maxBy(positions, p => p[0])[0];
                  const maxHeight = _.maxBy(positions, p => p[1])[1];
                  const width_original = maxLeft - posX_original;
                  const height_original = maxHeight - posY_original;
                  // document.getElementById('positions').innerHTML = `x=${posX_original}, y=${posY_original}, width=${width_original}, height=${height_original}`;

                  // Ajust to get more Ears
                  // if (height_original > width_original) {
                  //     const xPercent = 0.1, yPercent = 0.6;
                  //     const moreLefter = posX_original - width_original * xPercent;
                  //     posX = moreLefter > 0 ? moreLefter : 0;
                  //     const moreHeigter = posY_original - height_original * yPercent;
                  //     posY = moreHeigter > 0 ? moreHeigter : 0;
                  //     width = width_original * (1 + xPercent * 2);
                  //     height = height_original * (1 + yPercent);
                  // }

                  // Ajust to rect
                  if (height_original > width_original) {
                      const yPercent = 0.6;
                      let newHeight = height_original * (1 + yPercent); // 増高
                      newHeight = newHeight > canvasInput.height ? canvasInput.height : newHeight; // MAX高に超えないよう
                      const moreHeigterY = posY_original - (newHeight - height_original); // Yも増高
                      posY = moreHeigterY > 0 ? moreHeigterY : 0;// Yを枠に超えないよう
                      height = newHeight;

                      posX = posX_original - (height - width_original) / 2
                      width = height;
                  }
              }
          }
          positionLoop();

          function drawLoop() {
              requestAnimFrame(drawLoop);
              ctx.clearRect(0, 0, canvasInput.width, canvasInput.height);
              ctracker.draw(canvasInput);
              // Draw my rect
              ctx.strokeStyle = "red";
              ctx.strokeRect(posX, posY, width, height);

              // Draw icons
              const imageObj = new Image();
              // 32 px png icon
              imageObj.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAOw4AADsOAcy2oYMAAAAHdElNRQfjBRcGGSz0f5qTAAACFklEQVRIx63VzUtUYRQG8J93RlCQGDFHw/BjqwjOTsMWQYpIuAwx3Od/VLqWsnAjiShBShCIC0VcqSDiZJpCQyguDG2hjvc6d/zIzu4873nOe99zz3NOiXhLqtHksUr8krVh15+4wJIYLO25F9qknDhGqUDOkk8++3lTgpR+rz2y5Isl3x2gQp02z7T54a13copaxpQ9I9qVFZyVaTdiz5RMMXqvdQu6JItekNRtwbreeHrWuHo3Wb1x2cIUGavGVd9Ih2rjVqMPSZk0r+FWdGgwb1LqEhiyq/vWdOi2a+jCqbFoJF+6QFpaUECJ4kkjFtWcOQN2dOQDB61YMViQ4CreYccAJIyaVn4Opy07dWpZOkIvxMtNG5UI1MqYdXSnCsCRWRm1dNrWc82nFsd7bOukX1Zr0WJdh7fK6k9KOXYQgk8KFVcEP3AsFbinBXJKVYSQpCpBkdiqiNAqlMoFsgJ1IbjZRy2xCVp81Bzy6wSygQ25iDAONemKTdClyWHIz8jZuNpIJAxb1lhAb7RsWCLvnzcSV1uZVmvGLvr83GqMWYv87nwrXxUT9Nkyp1elhIRKveZs6YuUOiSmODl3mrFv0YQJi/bN6Iyc5+V8NpVTRj300mYo5IEnnmrApq+++R06a/DBvlfh+VxspJXEbI6Ykca9h+pZinULuv91rJ895M6L5a6r7Y330dX235fr5Wtvud7/AlAXs42d19StAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE5LTA1LTIzVDA2OjI1OjQ0LTA0OjAwIPJHewAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOS0wNS0yM1QwNjoyNTo0NC0wNDowMFGv/8cAAAAASUVORK5CYII='
              ctx.drawImage(imageObj, posX + width - 32, posY)

              // const trackerImgData = ctx.getImageData(posX, posY, maxLeft - posX, maxHeight - posY)

              // setTimeout VS requestAnimFrame: https://liginc.co.jp/web/js/130758
              // setTimeout(
              //     () => {
              //         // draw green line to image TODO
              //         // crop_img(ctx, trackerImgData);
              //         crop_video();
              //     },
              //     50);
              requestAnimFrame(crop_video)
          }
          drawLoop();

          const wsUrl = window.SERVER_URL ? window.SERVER_URL : "http://localhost:5000";
          // TODO set FPS
          const FPS = 5;

          const video = document.querySelector('video');
          navigator.mediaDevices.getUserMedia({video: {}}).then((stream) => video.srcObject = stream);
          // returns a frame encoded in base64
          const getFrame = () => {
              const canvas = document.createElement('canvas');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              canvas.getContext('2d').drawImage(video, 0, 0);
              return canvas.toDataURL('image/png');
          };
          const ws1 = io.connect(wsUrl + '/message');
          let sid = "";
          ws1.on("connect", () => {
              //console.log(`Connected to ${WS_URL}`);
              const img = document.getElementById("imgback");
              sid = ws1.io.engine.id;
              let chanSid = "imgback_" + sid;
              ws1.on(chanSid, (message) => {
                  // TODO according to status message.code to draw face, and replace graph pic with message.graph

                  // set the base64 string to the src tag of the image
                  // img.src = message.data;
              });
              setInterval(() => {
                  ws1.emit("message", crop_video());
              }, 1000 / FPS);
          })

          function crop_video() {
              // 画像切り取り
              var canvasTmp = document.createElement("canvas");
              canvasTmp.width = width;
              canvasTmp.height = height;
              var ctxTmp = canvasTmp.getContext("2d");
              ctxTmp.rect(0, 0,  width, height);
              // ctxTmp.fillStyle = 'white';
              // ctxTmp.fill();
              // ctxTmp.putImageData(crop.binarizer.source, 0, 0);
              ctxTmp.drawImage(videoInput,
                  posX, posY, width, height,
                  0, 0, width, height)
              // ctxTmp.putImageData(
              //     trackerImgData,
              //     0, 0);

              // ctxTmp.putImageData(
              //     trackerImgData,
              //     0, 0);

              if (width > height) {
                  croppedImageTag.setAttribute('width', width + 'px');
                  croppedImageTag.setAttribute('height', 'auto');
              } else if (height > 0) {
                  croppedImageTag.setAttribute('width', 'auto');
                  croppedImageTag.setAttribute('height', height + 'px');
              }

              croppedImage = canvasTmp.toDataURL("image/jpeg", 0.8);
              croppedImageTag.setAttribute('src', croppedImage);
              // console.log('Size of crop_video:', croppedImage.length)

              return resize_image(croppedImageTag, resizedImageTag)
          }

          function resize_image(src, dst, type, quality) {
              let tmp = new Image(),
                  canvas, context, cW, cH;

              type = type || 'image/jpeg';
              quality = quality || 0.8;

              cW = src.naturalWidth;
              cH = src.naturalHeight;

              tmp.src = src.src;
              tmp.onload = function () {

                  canvas = document.createElement('canvas');

                  if (cW < src.width) cW = src.width;
                  if (cH < src.height) cH = src.height;

                  const MAX_SEND_SIZE = 60;
                  // cW /= 2;
                  // cH /= 2;
                  cW = cW < MAX_SEND_SIZE ? cW : MAX_SEND_SIZE;
                  cH = cH < MAX_SEND_SIZE ? cH : MAX_SEND_SIZE;

                  canvas.width = cW;
                  canvas.height = cH;
                  context = canvas.getContext('2d');
                  context.drawImage(tmp, 0, 0, cW, cH);

                  resizedImage =  canvas.toDataURL(type, quality);
                  dst.src = resizedImage;
                  // console.log('Size of resize_image:', resizedImage.length)

                  if (cW <= src.width || cH <= src.height)
                      return;

                  tmp.src = dst.src;
                  return canvas.toDataURL(type, quality);
              }
          }
      });
  </script>
</body>
</html>
